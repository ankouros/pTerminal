app-id: com.github.ankouros.pterminal
runtime: org.gnome.Platform
runtime-version: "48"
sdk: org.gnome.Sdk
command: pterminal

finish-args:
  - --share=network
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --filesystem=xdg-download

sdk-extensions:
  - org.freedesktop.Sdk.Extension.golang

build-options:
  append-path: /usr/lib/sdk/golang/bin
  env:
    CGO_ENABLED: "1"

modules:
  - name: pterminal
    buildsystem: simple
    build-commands:
      # webview_go asks pkg-config for webkit2gtk-4.0; GNOME 46 provides 4.1.
      - |
        pc_path="$(pkg-config --variable pc_path pkg-config)"
        for d in ${pc_path//:/ }; do
          if [ -f "${d}/webkit2gtk-4.1.pc" ] && [ ! -f "${d}/webkit2gtk-4.0.pc" ]; then
            ln -sf "${d}/webkit2gtk-4.1.pc" "${d}/webkit2gtk-4.0.pc"
          fi
        done
      - go version
      - go env
      - go build -trimpath -buildvcs=false -ldflags "-s -w" -o /app/bin/pterminal ./cmd/pterminal
      - install -Dm644 packaging/flatpak/com.github.ankouros.pterminal.desktop /app/share/applications/com.github.ankouros.pterminal.desktop
      - install -Dm644 packaging/flatpak/com.github.ankouros.pterminal.svg /app/share/icons/hicolor/scalable/apps/com.github.ankouros.pterminal.svg
      - install -Dm644 packaging/flatpak/com.github.ankouros.pterminal.metainfo.xml /app/share/metainfo/com.github.ankouros.pterminal.metainfo.xml
    sources:
      - type: dir
        path: ../../
